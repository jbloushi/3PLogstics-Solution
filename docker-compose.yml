# ========================================
# Docker Compose - Target Logistics
# ========================================
# Production-ready multi-container setup
# Usage: docker-compose up -d

version: '3.8'

services:
  # ========================================
  # MongoDB Database Service
  # ========================================
  mongodb:
    image: mongo:7-jammy
    container_name: target-logistics-mongodb
    restart: unless-stopped

    environment:
      # MongoDB Authentication
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-cargo-tracker}

    ports:
      - "${MONGO_PORT:-27017}:27017"

    volumes:
      # Persistent data storage
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb

    networks:
      - target-logistics-network

    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ========================================
  # Backend API Service
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production

    container_name: target-logistics-api
    restart: unless-stopped

    depends_on:
      mongodb:
        condition: service_healthy

    environment:
      # Server Configuration
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 8899

      # Database Connection
      MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/${MONGO_DATABASE:-cargo-tracker}?authSource=admin

      # Security & Authentication
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN:-*}

      # API Keys
      DHL_API_KEY: ${DHL_API_KEY}
      DHL_API_SECRET: ${DHL_API_SECRET}
      DHL_ACCOUNT_NUMBER: ${DHL_ACCOUNT_NUMBER:-451012315}
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_TO_FILE: ${LOG_TO_FILE:-false}

      # Optional
      SENTRY_DSN: ${SENTRY_DSN:-}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}

    ports:
      - "${BACKEND_PORT:-8899}:8899"

    volumes:
      # Persistent uploads storage
      - backend_uploads:/app/uploads
      # Optional: Logs if LOG_TO_FILE=true
      - backend_logs:/app/logs

    networks:
      - target-logistics-network

    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  # ========================================
  # Frontend Service (Optional - Production Build)
  # ========================================
  # Uncomment to run frontend in Docker
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-/api}
        REACT_APP_GOOGLE_MAPS_API_KEY: ${REACT_APP_GOOGLE_MAPS_API_KEY}
        REACT_APP_MAPBOX_TOKEN: ${REACT_APP_MAPBOX_TOKEN}

    container_name: target-logistics-frontend
    restart: unless-stopped

    ports:
      - "${FRONTEND_PORT:-8833}:80"

    networks:
      - target-logistics-network

    depends_on:
      - backend
  # ========================================
  # Networks
  # ========================================
networks:
  target-logistics-network:
    driver: bridge
    name: target-logistics-net

# ========================================
# Volumes (Persistent Data)
# ========================================
volumes:
  mongodb_data:
    driver: local
    name: target-logistics-mongodb-data

  mongodb_config:
    driver: local
    name: target-logistics-mongodb-config

  backend_uploads:
    driver: local
    name: target-logistics-uploads

  backend_logs:
    driver: local
    name: target-logistics-logs
